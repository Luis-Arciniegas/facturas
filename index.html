<html><head><base href="https://www.papanoeldelicias.com/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura Editable - Papa Noel Sus Delicias y Variedades</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #c41e3a;
            --secondary-color: #228B22;
            --background-color: #f8f9fa;
            --text-color: #333;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .invoice-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 20px;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            background-color: var(--primary-color);
            color: #fff;
            padding: 20px;
            border-radius: 10px;
        }
        
        h1 {
            color: #fff;
            font-size: 2.5em;
            margin: 0 0 10px;
        }
        
        .company-info {
            text-align: center;
            margin-bottom: 0;
        }
        
        .company-info p {
            margin: 5px 0;
        }

        .company-info .company-name {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .invoice-details, .client-details, .product-details, .saved-invoices {
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
        }
        
        h2 {
            color: var(--secondary-color);
            margin-top: 0;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .detail-label {
            font-weight: bold;
            flex-basis: 40%;
        }
        
        .detail-value {
            flex-basis: 60%;
        }
        
        input, select {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .product-description {
            width: 40%;
        }

        th {
            background-color: var(--secondary-color);
            color: #fff;
        }
        
        .totals {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .total-item {
            margin-left: 20px;
            text-align: right;
        }
        
        .total-label {
            font-weight: bold;
        }
        
        .total-value {
            font-size: 1.2em;
            color: var(--primary-color);
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: #fff;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .checkbox-row .detail-value {
            display: flex;
            flex-wrap: wrap;
        }
        
        .checkbox-row label {
            margin-right: 20px;
            display: flex;
            align-items: center;
        }
        
        .checkbox-row input[type="checkbox"] {
            margin-right: 5px;
            width: auto;
        }

        .saved-invoices #saved-invoices-list {
            margin-bottom: 10px;
        }

        .saved-invoices #saved-invoices-list div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .saved-invoices #saved-invoices-list button {
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            body {
                padding: 20px;
            }

            .invoice-container {
                padding: 20px;
            }

            .detail-row {
                flex-direction: column;
            }

            .detail-label, .detail-value {
                flex-basis: 100%;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 5px;
            }

            .product-description {
                width: 30%;
            }

            .totals {
                flex-direction: column;
                align-items: flex-end;
            }

            .total-item {
                margin-left: 0;
                margin-bottom: 10px;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="invoice-container">
        <div class="header">
            <h1>FACTURA</h1>
            <div class="company-info">
                <p class="company-name">Papa Noel sus delicias y variedades</p>
                <p>C.C/NIT: 1070605970-2</p>
                <p>CEL: 3214774125</p>
                <p>Dirección: KR 5 No 44 A 80 LT 7 GIRARDOT EL PANTANO GIRASOL</p>
            </div>
        </div>
        
        <div class="invoice-details">
            <h2>Detalles de la Factura</h2>
            <div class="detail-row">
                <span class="detail-label">Número de Factura:</span>
                <span class="detail-value"><input type="text" id="invoice-number" value="INV-001"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Fecha:</span>
                <span class="detail-value"><input type="date" id="invoice-date"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Forma de Pago:</span>
                <span class="detail-value">
                    <select id="payment-method">
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta</option>
                        <option value="transferencia">Transferencia</option>
                    </select>
                </span>
            </div>
            <div class="detail-row checkbox-row">
                <span class="detail-label">Opciones:</span>
                <span class="detail-value">
                    <label><input type="checkbox" id="account-checkbox"> Cuenta de Cobro</label>
                    <label><input type="checkbox" id="order-checkbox"> Pedido</label>
                    <label><input type="checkbox" id="quote-checkbox"> Cotización</label>
                    <label><input type="checkbox" id="remission-checkbox"> Remisión</label>
                </span>
            </div>
        </div>
        
        <div class="client-details">
            <h2>Datos del Cliente</h2>
            <div class="detail-row">
                <span class="detail-label">SEÑOR(ES):</span>
                <span class="detail-value"><input type="text" id="client-name"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">DIRECCIÓN:</span>
                <span class="detail-value"><input type="text" id="client-address"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">C.C./NIT:</span>
                <span class="detail-value"><input type="text" id="client-id"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">CIUDAD:</span>
                <span class="detail-value"><input type="text" id="client-city"></span>
            </div>
        </div>
        
        <div class="product-details">
            <h2>Detalle de Productos</h2>
            <table id="product-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">Cantidad</th>
                        <th class="product-description">Descripción</th>
                        <th style="width: 20%;">Valor Unitario</th>
                        <th style="width: 20%;">Valor Total</th>
                        <th style="width: 15%;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas de productos se añadirán dinámicamente aquí -->
                </tbody>
            </table>
            
            <button class="btn btn-secondary" onclick="addProductRow()">Agregar Producto</button>
            
            <div class="totals">
                <div class="total-item">
                    <div class="total-label">Subtotal:</div>
                    <div class="total-value" id="subtotal">$0,00</div>
                </div>
                <div class="total-item">
                    <div class="total-label">IVA (%):</div>
                    <div class="total-value">
                        <input type="number" id="iva-input" min="0" max="100" step="0.1" value="0" onchange="updateTotal()">
                    </div>
                </div>
                <div class="total-item">
                    <div class="total-label">IVA Monto:</div>
                    <div class="total-value" id="iva-amount">$0,00</div>
                </div>
                <div class="total-item">
                    <div class="total-label">Total:</div>
                    <div class="total-value" id="total">$0,00</div>
                </div>
            </div>
        </div>

        <div class="saved-invoices">
            <h2>Facturas Guardadas</h2>
            <div id="saved-invoices-list">
                <!-- Saved invoices will be added here dynamically -->
            </div>
            <button class="btn btn-secondary" onclick="loadSavedInvoice()">Cargar Factura</button>
        </div>
        
        <div class="actions">
            <button class="btn btn-secondary" onclick="saveInvoice()">Guardar Factura</button>
            <button class="btn btn-secondary" onclick="generatePDF()">Generar PDF</button>
        </div>
    </div>

    <script>
        let currentInvoice = null;

        function formatNumber(num) {
            return num.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        document.getElementById('invoice-date').valueAsDate = new Date();

        function updateAllTotals() {
            const rows = document.querySelectorAll('#product-table tbody tr');
            rows.forEach(row => {
                const quantityInput = row.querySelector('.quantity');
                updateRowTotal(quantityInput);
            });
            updateSubtotal();
        }

        function addProductRow() {
            const tbody = document.querySelector('#product-table tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="number" class="quantity" min="1" value="1" onchange="updateRowTotal(this)"></td>
                <td class="product-description"><input type="text" class="description"></td>
                <td><input type="number" class="unit-price" min="0" step="0.01" value="0" onchange="updateRowTotal(this); this.value = formatNumber(parseFloat(this.value) || 0);"></td>
                <td class="row-total">$0,00</td>
                <td><button onclick="removeProductRow(this)">Eliminar</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeProductRow(button) {
            const row = button.closest('tr');
            row.remove();
            updateSubtotal();
        }

        function updateRowTotal(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
            const total = quantity * unitPrice;
            row.querySelector('.row-total').textContent = `$${formatNumber(total)}`;
            updateSubtotal();
        }

        function updateSubtotal() {
            const rowTotals = document.querySelectorAll('.row-total');
            let subtotal = 0;
            rowTotals.forEach(cell => {
                subtotal += parseFloat(cell.textContent.replace('$', '').replace(/\./g, '').replace(',', '.')) || 0;
            });
            document.getElementById('subtotal').textContent = `$${formatNumber(subtotal)}`;
            updateTotal();
        }

        function updateTotal() {
            try {
                const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('$', '').replace(/\./g, '').replace(',', '.'));
                const ivaPercentage = parseFloat(document.getElementById('iva-input').value);
                const ivaAmount = subtotal * (ivaPercentage / 100);
                const total = subtotal + ivaAmount;

                document.getElementById('iva-amount').textContent = `$${formatNumber(ivaAmount)}`;
                document.getElementById('total').textContent = `$${formatNumber(total)}`;
            } catch (error) {
                console.error('Error updating total:', error);
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 10;
            let yPos = margin;

            doc.setFillColor(196, 30, 58); // Primary color
            doc.rect(0, 0, pageWidth, 40, 'F');

            doc.setFont("helvetica");
            doc.setFontSize(24);
            doc.setTextColor(255, 255, 255);
            doc.text("FACTURA", pageWidth / 2, yPos + 15, { align: "center" });

            yPos += 40;

            doc.setFontSize(14);
            doc.setTextColor(34, 139, 34); // Secondary color
            doc.text("Papa Noel sus delicias y variedades", pageWidth / 2, yPos, { align: "center" });
            yPos += 7;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text("C.C/NIT: 1070605970-2", pageWidth / 2, yPos, { align: "center" });
            yPos += 5;
            doc.text("CEL: 3214774125", pageWidth / 2, yPos, { align: "center" });
            yPos += 5;
            doc.text("Dirección: KR 5 No 44 A 80 LT 7 GIRARDOT EL PANTANO GIRASOL", pageWidth / 2, yPos, { align: "center" });
            yPos += 15;

            yPos = addSection(doc, "Detalles de la Factura", yPos);
            yPos = addField(doc, "Número de Factura:", document.getElementById('invoice-number').value, yPos);
            yPos = addField(doc, "Fecha:", document.getElementById('invoice-date').value, yPos);
            yPos = addField(doc, "Forma de Pago:", document.getElementById('payment-method').value, yPos);
            yPos += 10;

            yPos = addSection(doc, "Datos del Cliente", yPos);
            yPos = addField(doc, "SEÑOR(ES):", document.getElementById('client-name').value, yPos);
            yPos = addField(doc, "DIRECCIÓN:", document.getElementById('client-address').value, yPos);
            yPos = addField(doc, "C.C./NIT:", document.getElementById('client-id').value, yPos);
            yPos = addField(doc, "CIUDAD:", document.getElementById('client-city').value, yPos);
            yPos += 10;

            const headers = ["Cantidad", "Descripción", "Valor Unitario", "Valor Total"];
            const productData = getProductData();
            yPos = addTable(doc, headers, productData, yPos);

            yPos = addField(doc, "Subtotal:", document.getElementById('subtotal').textContent, yPos);
            yPos = addField(doc, "IVA (%):", document.getElementById('iva-input').value + "%", yPos);
            yPos = addField(doc, "IVA Monto:", document.getElementById('iva-amount').textContent, yPos);
            yPos = addField(doc, "Total:", document.getElementById('total').textContent, yPos);

            doc.save("factura.pdf");
        }

        function addSection(doc, title, y) {
            doc.setFontSize(14);
            doc.setTextColor(34, 139, 34);
            doc.text(title, 20, y);
            return y + 10;
        }

        function addField(doc, label, value, y) {
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            if (value.startsWith('$')) {
                doc.text(label, 20, y);
                doc.text(value, 190, y, { align: 'right' });
            } else {
                doc.text(`${label} ${value}`, 20, y);
            }
            return y + 7;
        }

        function addTable(doc, headers, data, y) {
            const startY = y;
            const cellPadding = 2;
            const pageWidth = doc.internal.pageSize.getWidth();
            const tableWidth = pageWidth - 20;
            const cellWidths = [tableWidth * 0.1, tableWidth * 0.5, tableWidth * 0.2, tableWidth * 0.2];
            const cellHeight = 8;

            doc.setFillColor(220, 220, 220);
            doc.setTextColor(0, 0, 0);
            headers.forEach((header, i) => {
                doc.rect(10 + (i > 0 ? cellWidths.slice(0, i).reduce((a, b) => a + b, 0) : 0), y, cellWidths[i], cellHeight, 'F');
                doc.text(header, 10 + (i > 0 ? cellWidths.slice(0, i).reduce((a, b) => a + b, 0) : 0) + cellPadding, y + cellHeight - cellPadding);
            });
            y += cellHeight;

            doc.setTextColor(0, 0, 0);
            data.forEach(row => {
                let maxHeight = cellHeight;
                row.forEach((cell, i) => {
                    const cellWidth = cellWidths[i];
                    const lines = doc.splitTextToSize(cell.toString(), cellWidth - 2 * cellPadding);
                    const cellContentHeight = lines.length * 5;
                    maxHeight = Math.max(maxHeight, cellContentHeight + 2 * cellPadding);
                });

                row.forEach((cell, i) => {
                    const xPos = 10 + (i > 0 ? cellWidths.slice(0, i).reduce((a, b) => a + b, 0) : 0);
                    doc.rect(xPos, y, cellWidths[i], maxHeight, 'S');
                    const lines = doc.splitTextToSize(cell.toString(), cellWidths[i] - 2 * cellPadding);
                    doc.text(lines, xPos + cellPadding, y + 5);
                });
                y += maxHeight;
            });

            return y + 5;
        }

        function getProductData() {
            const rows = document.querySelectorAll('#product-table tbody tr');
            return Array.from(rows).map(row => [
                row.querySelector('.quantity').value,
                row.querySelector('.description').value,
                `$${formatNumber(parseFloat(row.querySelector('.unit-price').value) || 0)}`,
                row.querySelector('.row-total').textContent
            ]);
        }

        function saveInvoice() {
            const invoice = {
                number: document.getElementById('invoice-number').value,
                date: document.getElementById('invoice-date').value,
                paymentMethod: document.getElementById('payment-method').value,
                clientName: document.getElementById('client-name').value,
                clientAddress: document.getElementById('client-address').value,
                clientId: document.getElementById('client-id').value,
                clientCity: document.getElementById('client-city').value,
                products: getProductData(),
                subtotal: document.getElementById('subtotal').textContent,
                iva: document.getElementById('iva-input').value,
                ivaAmount: document.getElementById('iva-amount').textContent,
                total: document.getElementById('total').textContent
            };

            let savedInvoices = JSON.parse(localStorage.getItem('invoices')) || {};
            savedInvoices[invoice.number] = invoice;
            localStorage.setItem('invoices', JSON.stringify(savedInvoices));

            updateSavedInvoicesList();
        }

        function updateSavedInvoicesList() {
            const savedInvoices = JSON.parse(localStorage.getItem('invoices')) || {};
            const container = document.getElementById('saved-invoices-list');
            container.innerHTML = '';
            Object.keys(savedInvoices).forEach(invoiceNumber => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <span>${invoiceNumber}</span>
                    <button onclick="loadSavedInvoice('${invoiceNumber}')">Cargar</button>
                    <button onclick="deleteSavedInvoice('${invoiceNumber}')">Eliminar</button>
                `;
                container.appendChild(div);
            });
        }

        function deleteSavedInvoice(invoiceNumber) {
            if (confirm(`¿Está seguro de que desea eliminar la factura ${invoiceNumber}?`)) {
                let savedInvoices = JSON.parse(localStorage.getItem('invoices')) || {};
                delete savedInvoices[invoiceNumber];
                localStorage.setItem('invoices', JSON.stringify(savedInvoices));
                updateSavedInvoicesList();
            }
        }

        function loadSavedInvoice(invoiceNumber) {
            const savedInvoices = JSON.parse(localStorage.getItem('invoices')) || {};
            const invoice = savedInvoices[invoiceNumber];

            if (invoice) {
                document.getElementById('invoice-number').value = invoice.number;
                document.getElementById('invoice-date').value = invoice.date;
                document.getElementById('payment-method').value = invoice.paymentMethod;
                document.getElementById('client-name').value = invoice.clientName;
                document.getElementById('client-address').value = invoice.clientAddress;
                document.getElementById('client-id').value = invoice.clientId;
                document.getElementById('client-city').value = invoice.clientCity;

                const tbody = document.querySelector('#product-table tbody');
                tbody.innerHTML = '';
                invoice.products.forEach(product => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="number" class="quantity" min="1" value="${product[0]}" onchange="updateRowTotal(this)"></td>
                        <td class="product-description"><input type="text" class="description" value="${product[1]}"></td>
                        <td><input type="number" class="unit-price" min="0" step="0.01" value="${parseFloat(product[2].replace('$', '').replace(/\./g, '').replace(',', '.'))}" onchange="updateRowTotal(this)"></td>
                        <td class="row-total">${product[3]}</td>
                        <td><button onclick="removeProductRow(this)">Eliminar</button></td>
                    `;
                    tbody.appendChild(newRow);
                });

                document.getElementById('iva-input').value = invoice.iva;
                updateAllTotals(); // Add this line to update all totals after loading
            }
        }

        function getNextInvoiceNumber() {
            const savedInvoices = JSON.parse(localStorage.getItem('invoices')) || {};
            const numbers = Object.keys(savedInvoices).map(num => parseInt(num.replace('INV-', '')));
            const maxNumber = Math.max(0, ...numbers);
            return `INV-${String(maxNumber + 1).padStart(3, '0')}`;
        }

        document.getElementById('invoice-number').value = getNextInvoiceNumber();
        updateSavedInvoicesList();
        addProductRow();
    </script>
</body></html>